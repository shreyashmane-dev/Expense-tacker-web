<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile - Expense Manager</title>
<link rel="stylesheet" href="../css/main.css">
<link rel="manifest" href="../manifest.json">
<script type="module" src="../js/auth-guard.js"></script>
</head>
<body class="animate-up">

<div class="navbar">
  <a data-page="home" href="home.html" class="nav-link">
    <span>ğŸ </span>Home
  </a>
  <a data-page="history" href="history.html" class="nav-link">
    <span>ğŸ“œ</span>History
  </a>
  <a data-page="analysis" href="analysis.html" class="nav-link">
    <span>ğŸ“Š</span>Analysis
  </a>
  <a data-page="profile" href="profile.html" class="nav-link active">
    <span>ğŸ‘¤</span>Profile
  </a>
</div>

<main class="container">
  <header style="margin-bottom: 24px;">
    <h2 style="font-size: 28px; margin-bottom: 8px;">My Profile</h2>
    <p style="color: #64748b; font-size: 14px;">Manage your account and app settings.</p>
  </header>

  <!-- Profile Overview Card -->
  <div class="card" style="text-align: center; position: relative;">
    <button id="logoutBtn" style="position: absolute; top: 16px; right: 16px; width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(239, 68, 68, 0.1); color: var(--danger); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" title="Logout">
      <span style="font-size: 18px;">ğŸšª</span>
    </button>
    
    <div id="profileAvatar" style="width: 100px; height: 100px; border-radius: 50%; background: var(--grad-main); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; font-weight: 700; box-shadow: var(--shadow-lg);">U</div>
    <h2 id="displayName" style="margin-bottom: 4px; font-family: var(--font-display);">Loading...</h2>
    <p id="displayEmail" style="color: #64748b; font-size: 14px; margin-bottom: 24px;">loading@example.com</p>

    <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; text-align: left;">
      <div class="form-group">
        <label style="font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; display: block; margin-bottom: 4px;">Full Name</label>
        <input type="text" id="profileName" placeholder="Full Name"/>
        
        <label style="font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; display: block; margin-bottom: 4px;">Role / Occupation</label>
        <select id="profileRole">
          <option>Student</option>
          <option>Employee</option>
          <option>Business Owner</option>
          <option>Freelancer</option>
        </select>
        
        <div class="grid-2" style="margin-bottom: 0;">
          <div>
            <label style="font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; display: block; margin-bottom: 4px;">Monthly Income (â‚¹)</label>
            <input type="number" id="profileIncome" placeholder="e.g. 50000"/>
          </div>
          <div>
            <label style="font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; display: block; margin-bottom: 4px;">Monthly Budget (â‚¹)</label>
            <input type="number" id="profileBudget" placeholder="e.g. 20000"/>
          </div>
        </div>

        <label style="font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; display: block; margin-bottom: 4px;">Member Since</label>
        <input type="text" id="profileJoined" readonly style="background: #f8fafc; cursor: not-allowed;"/>
        
        <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 20px;">
          <input type="checkbox" id="profileSmsToggle" style="width: auto; margin: 0;"/>
          <label for="profileSmsToggle" style="font-size: 14px; font-weight: 500; color: #475569;">Enable Automatic SMS Tracking</label>
        </div>

        <button id="updateProfileBtn" class="btn">Save Profile Settings</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-bottom: 12px;">App Permissions</h3>
    <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">Granting these permissions allows the app to automatically track your expenses from bank messages and notifications.</p>
    <button id="requestSmsBtn" class="btn btn-secondary" style="margin-bottom: 12px; background: rgba(16, 185, 129, 0.1); color: var(--accent); border-color: rgba(16, 185, 129, 0.2);">
      <span>ğŸ“±</span> Grant SMS Permission
    </button>
    <p style="font-size: 11px; color: #94a3b8; text-align: center;">Data is processed on-device and never shared with third parties.</p>
  </div>
</main>

<!-- Scripts -->
<script type="module" src="../js/app.js"></script>
<script type="module" src="../js/sms-permission.js"></script>

<script type="module">
import { auth, db } from "../js/firebase.js";
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

onAuthStateChanged(auth, async (user) => {
  // GUEST MODE
  if (!user && sessionStorage.getItem('guest_mode') === 'true') {
    document.getElementById("displayName").textContent = "Guest User";
    document.getElementById("displayEmail").textContent = "Offline Mode (Guest)";
    document.getElementById("profileAvatar").textContent = "G";
    document.getElementById("profileJoined").value = new Date().toLocaleDateString();
    
    document.querySelectorAll("input, select").forEach(el => {
      if (el.id !== "profileSmsToggle" && el.id !== "profileName") el.disabled = true;
    });

    const btn = document.getElementById("updateProfileBtn");
    btn.textContent = "Login to Sync Data";
    btn.onclick = () => {
      sessionStorage.removeItem("guest_mode");
      window.location.href = "/auth/login.html";
    };

    document.getElementById("logoutBtn").addEventListener("click", () => {
      sessionStorage.removeItem("guest_mode");
      window.location.href = "/auth/login.html";
    });
    return;
  }

  if (!user) return;
  
  const uid = user.uid;
  const docRef = doc(db, "users", uid);
  const snapshot = await getDoc(docRef);
  
  if (snapshot.exists()) {
    const data = snapshot.data();
    document.getElementById("profileName").value = data.name || "";
    document.getElementById("displayName").textContent = data.name || "User";
    document.getElementById("displayEmail").textContent = data.email || user.email;
    document.getElementById("profileRole").value = data.role || "Student";
    document.getElementById("profileIncome").value = data.monthlyIncome || "";
    document.getElementById("profileBudget").value = data.monthlyBudget || "";
    document.getElementById("profileJoined").value = data.createdAt ? new Date(data.createdAt).toLocaleDateString('en-IN', {day:'2-digit', month:'long', year:'numeric'}) : "Welcome aboard!";
    document.getElementById("profileSmsToggle").checked = data.smsEnabled || false;
    document.getElementById("profileAvatar").textContent = (data.name || "U")[0].toUpperCase();
  } else {
    document.getElementById("displayName").textContent = user.email.split('@')[0];
    document.getElementById("displayEmail").textContent = user.email;
    document.getElementById("profileAvatar").textContent = user.email[0].toUpperCase();
  }

  document.getElementById("updateProfileBtn").addEventListener("click", async () => {
    const btn = document.getElementById("updateProfileBtn");
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "Saving changes...";
    
    try {
      await setDoc(docRef, {
        name: document.getElementById("profileName").value,
        email: user.email,
        role: document.getElementById("profileRole").value,
        monthlyIncome: Number(document.getElementById("profileIncome").value),
        smsEnabled: document.getElementById("profileSmsToggle").checked,
        monthlyBudget: Number(document.getElementById("profileBudget").value)
      }, { merge: true });
      
      localStorage.setItem("monthlyBudget", document.getElementById("profileBudget").value);
      
      btn.textContent = "Settings Saved! âœ“";
      btn.style.background = "var(--accent)";
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = originalText;
        btn.style.background = "";
      }, 2000);
      
      document.getElementById("displayName").textContent = document.getElementById("profileName").value;
      document.getElementById("profileAvatar").textContent = (document.getElementById("profileName").value || "U")[0].toUpperCase();

    } catch (error) {
      console.error("Error updating profile:", error);
      alert("Failed to update profile.");
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "/auth/login.html";
    } catch (error) {
      alert("Logout failed: " + error.message);
    }
  });
});
</script>

</body>
</html>
