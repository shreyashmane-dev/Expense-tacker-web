import{a as r,d}from"./firebase-CCPgoP9_.js";import"./navbar-gesture-C5axQr5-.js";import{doc as m,getDoc as s,setDoc as c}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";import{onAuthStateChanged as u,signOut as g}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";import"https://cdn.jsdelivr.net/npm/chart.js@4.4.1/+esm";const p=document.getElementById("requestSmsBtn"),n=document.getElementById("smsToggle");n&&(n.checked=localStorage.getItem("smsEnabled")==="true");p?.addEventListener("click",async()=>{if(!window.Capacitor){alert("SMS tracking works only in the Android app. On web, use the SMS Simulator on the Home page for testing.");return}const t=window.cordova?.plugins?.permissions;if(!t){console.error("Cordova Permissions plugin not found"),alert("Permission plugin missing. Please rebuild app.");return}const l=[t.RECEIVE_SMS,t.READ_SMS];t.checkPermission(l,a=>{a.hasPermission?o():t.requestPermissions(l,e=>{e.hasPermission?o():alert("❌ SMS permissions denied. Please enable them in Settings.")},()=>{alert("Failed to request permissions.")})},null);function o(){localStorage.setItem("smsEnabled","true"),n&&(n.checked=!0),alert("✅ SMS tracking enabled! Transactions will be added automatically.")}});n?.addEventListener("change",()=>{const t=n.checked;localStorage.setItem("smsEnabled",t.toString()),console.log(t?"SMS tracking enabled":"SMS tracking disabled")});u(r,async t=>{if(!t&&sessionStorage.getItem("guest_mode")==="true"){document.getElementById("displayName").textContent="Guest User",document.getElementById("displayEmail").textContent="Offline Mode",document.getElementById("profileAvatar").textContent="G",document.getElementById("profileJoined").value=new Date().toLocaleDateString(),document.querySelectorAll("input, select").forEach(i=>{i.id!=="profileSmsToggle"&&(i.disabled=!0)});const e=document.getElementById("updateProfileBtn");e.textContent="Login to Sync Data",e.style.background="#2563eb",e.onclick=()=>{sessionStorage.removeItem("guest_mode"),window.location.href="/auth/login.html"},document.getElementById("logoutBtn").addEventListener("click",()=>{sessionStorage.removeItem("guest_mode"),window.location.href="/auth/login.html"});return}if(!t)return;const l=t.uid,o=m(d,"users",l),a=await s(o);if(a.exists()){const e=a.data();document.getElementById("profileName").value=e.name||"",document.getElementById("displayName").textContent=e.name||"User",document.getElementById("displayEmail").textContent=e.email||t.email,document.getElementById("profileRole").value=e.role||"Student",document.getElementById("profileIncome").value=e.monthlyIncome||"",document.getElementById("profileCurrency").value=e.currency||"₹",document.getElementById("profileJoined").value=e.createdAt?new Date(e.createdAt).toLocaleDateString("en-IN",{day:"2-digit",month:"long",year:"numeric"}):"Unknown",document.getElementById("profileSmsToggle").checked=e.smsEnabled||!1,document.getElementById("profileAvatar").textContent=(e.name||"U")[0].toUpperCase()}document.getElementById("updateProfileBtn").addEventListener("click",async()=>{const e=document.getElementById("updateProfileBtn");e.disabled=!0,e.textContent="Updating...";try{await c(o,{name:document.getElementById("profileName").value,email:t.email,role:document.getElementById("profileRole").value,monthlyIncome:Number(document.getElementById("profileIncome").value),currency:document.getElementById("profileCurrency").value,smsEnabled:document.getElementById("profileSmsToggle").checked},{merge:!0}),e.textContent="Profile Updated! ✓",e.style.background="#10b981",setTimeout(()=>{e.disabled=!1,e.textContent="Save Profile Settings",e.style.background=""},2e3),document.getElementById("displayName").textContent=document.getElementById("profileName").value,document.getElementById("profileAvatar").textContent=(document.getElementById("profileName").value||"U")[0].toUpperCase()}catch(i){console.error("Error updating profile:",i),alert("Failed to update profile."),e.disabled=!1,e.textContent="Save Profile Settings"}}),document.getElementById("logoutBtn").addEventListener("click",async()=>{try{await g(r),window.location.href="/auth/login.html"}catch(e){console.error("Logout error:",e),alert("Failed to logout: "+e.message)}})});
